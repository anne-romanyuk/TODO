<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Cyber To-Do</title>
  <div class="user-header-bar">
    <span class="user-name-neon" id="userDisplay"></span>
    <button id="logoutBtn" class="logout-btn">
      <span class="logout-icon">
        <svg height="20" width="20" viewBox="0 0 24 24" fill="none" style="vertical-align: middle;">
          <path d="M16 17l5-5m0 0l-5-5m5 5H9" stroke="#0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M13 7V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-2" stroke="#0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>
      <span class="logout-label">Logout</span>
    </button>
  </div>

  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
</head>
<body class="dashboard-page">

  <div id="startTaskModal" class="modal">
    <div class="modal-box">
      <h2>Start the task</h2>
      <input type="number" id="startMinutes" placeholder="Duration in minutes" />
      <button onclick="startTimer()">Start</button>
    </div>
  </div>

  <div class="active-tasks-box">
    <h3>Active tasks</h3>
    <ul id="activeTaskList"></ul>
    <p id="activeTaskNote">You have no active tasks</p>
  </div>

  <div class="tasks-section-header">
    <span>Your tasks for </span>
    <span id="dateDisplay" class="date-display">
      Today <span class="chevron">&#x25BC;</span>
    </span>
    <div id="dateDropdown" class="date-dropdown">
      <div data-value="today" class="dropdown-item">Today</div>
      <div data-value="tomorrow" class="dropdown-item">Tomorrow</div>
      <div data-value="this_week" class="dropdown-item">This Week</div>
      <div data-value="next_week" class="dropdown-item">Next Week</div>
      <div data-value="custom" class="dropdown-item">Select Date...</div>
    </div>
    <input type="text" id="headerCustomDateInput" style="display:none;" placeholder="Pick a date" readonly />
  </div>
  
  <div class="todo-container">
    <ul id="taskList" class="centered-wide"></ul>
    <div class="add-task-container">
      <div class="add-task-row">
        <input type="text" id="taskTitle" placeholder="Task title" onkeypress="if(event.key==='Enter') addTask()" />
        <input type="text" id="taskDate" placeholder="Date" autocomplete="off" />
        <input type="number" id="taskDuration" placeholder="Duration (mins)" onkeypress="if(event.key==='Enter') addTask()" />
        <button onclick="addTask()">Add</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const API_BASE = 'http://64.225.68.22:8090';
    const user = localStorage.getItem("currentUser");
    let allTasks = [];
    let currentDateFilter = "today";
    let currentCustomDate = null;
    let _activeTimersInterval = null;

    function getYMD(date) {
      if (!date) return '';
      if (typeof date !== "string") {
        return date.getFullYear().toString().padStart(4, '0') + "-" +
               (date.getMonth() + 1).toString().padStart(2, '0') + "-" +
               date.getDate().toString().padStart(2, '0');
      }
      return date;
    }

    async function loadTasks() {
      try {
        const res = await fetch(`${API_BASE}/api/tasks`, { headers: { "X-User": user } });
        allTasks = await res.json();
        renderActiveTasks(allTasks);
        filterAndRenderTasks();
      } catch {
        alert("Error loading tasks");
      }
    }

    function filterAndRenderTasks() {
      let filtered = [];
      const now = new Date();
      const todayYMD = getYMD(now);

      if (currentDateFilter === "today") {
        filtered = allTasks.filter(task => getYMD(task.taskDate) === todayYMD);
      } else if (currentDateFilter === "tomorrow") {
        const tomorrow = new Date(now);
        tomorrow.setDate(now.getDate() + 1);
        const tomorrowYMD = getYMD(tomorrow);
        filtered = allTasks.filter(task => getYMD(task.taskDate) === tomorrowYMD);
      } else if (currentDateFilter === "this_week") {
        const startYMD = todayYMD;
        const end = new Date(now);
        end.setDate(now.getDate() + (7 - now.getDay() || 7) - 1);
        const endYMD = getYMD(end);
        filtered = allTasks.filter(task => {
          const ymd = getYMD(task.taskDate);
          return ymd >= startYMD && ymd <= endYMD;
        });
      } else if (currentDateFilter === "next_week") {
        const nextMonday = new Date(now);
        nextMonday.setDate(now.getDate() + ((8 - now.getDay()) % 7 || 7));
        const nextMondayYMD = getYMD(nextMonday);
        const nextSunday = new Date(nextMonday);
        nextSunday.setDate(nextMonday.getDate() + 6);
        const nextSundayYMD = getYMD(nextSunday);
        filtered = allTasks.filter(task => {
          const ymd = getYMD(task.taskDate);
          return ymd >= nextMondayYMD && ymd <= nextSundayYMD;
        });
      } else if (currentDateFilter === "custom" && currentCustomDate) {
        filtered = allTasks.filter(task => getYMD(task.taskDate) === getYMD(currentCustomDate));
      } else {
        filtered = allTasks;
      }
      renderTaskList(filtered);
    }

    function renderTaskList(tasks) {
      const list = document.getElementById("taskList");
      list.innerHTML = "";
      if (!tasks.length) {
        const li = document.createElement("li");
        li.textContent = "You have no tasks yet.";
        li.style.cssText = "text-align:center;padding:20px;color:#0ff;opacity:0.6;font-style:italic;";
        list.appendChild(li);
        return;
      }
      tasks.forEach(task => {
        const li = document.createElement("li");
        li.className = "task-box";
        li.style.display = "flex";
        li.style.alignItems = "center";
        li.style.gap = "25px";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "custom-checkbox";
        checkbox.addEventListener("change", () => {
          span.style.textDecoration = checkbox.checked ? "line-through" : "none";
        });

        const taskLine = document.createElement("div");
        taskLine.className = "task-line";
        taskLine.style.flex = "1";
        taskLine.style.cursor = "pointer";
        taskLine.addEventListener("click", (e) => {
          openStartModal(task.title, task.id, task.durationMinutes);
          e.stopPropagation();
        });

        const span = document.createElement("span");
        // ==== NO DATE HERE ====
        span.innerHTML = `<strong>${task.title}</strong>${task.durationMinutes ? ` (${task.durationMinutes} mins)` : ""}`;
        taskLine.appendChild(span);

        li.appendChild(checkbox);
        li.appendChild(taskLine);
        list.appendChild(li);
      });
    }

    // ==== ACTIVE TASKS ====
    function renderActiveTasks(tasks) {
      // Stop existing timers
      if (_activeTimersInterval) clearInterval(_activeTimersInterval);

      const list = document.getElementById("activeTaskList");
      const note = document.getElementById("activeTaskNote");
      list.innerHTML = "";

      const activeTasks = tasks.filter(task => task.status === "ACTIVE");
      if (!activeTasks.length) {
        note.style.display = "block";
        list.style.display = "none";
        return;
      }
      note.style.display = "none";
      list.style.display = "block";

      activeTasks.forEach(task => {
        const li = document.createElement("li");
        li.className = "task-box active-big";
        li.style.display = "flex";
        li.style.alignItems = "center";
        li.style.gap = "30px";
        li.style.fontSize = "1.6em";

        // Big Checkbox
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "custom-checkbox active-big-checkbox";
        checkbox.style.transform = "scale(2.0)";
        checkbox.checked = task.status === "COMPLETED";
        checkbox.addEventListener("change", async () => {
          await updateTaskStatus(task.id, "COMPLETED");
          await loadTasks();
        });

        // Task text
        const taskLine = document.createElement("div");
        taskLine.className = "task-line";
        taskLine.style.flex = "1";
        taskLine.style.cursor = "pointer";
        taskLine.addEventListener("click", (e) => {
          openStartModal(task.title, task.id, task.durationMinutes);
          e.stopPropagation();
        });

        const span = document.createElement("span");
        // ==== NO DATE HERE ====
        span.innerHTML = `<strong>${task.title}</strong>${task.durationMinutes ? ` (${task.durationMinutes} mins)` : ""}`;
        taskLine.appendChild(span);

        // TIMER
        const timer = document.createElement("span");
        timer.className = "task-timer";
        timer.dataset.taskid = task.id;
        timer.style.marginLeft = "30px";

        // Logic: Get endTime from localStorage, else set now+duration
        let duration = task.durationMinutes ? task.durationMinutes * 60 : 0;
        let endTime = null;
        if (duration) {
          const timerKey = `activeTask_${task.id}_endTime`;
          if (!localStorage.getItem(timerKey)) {
            endTime = Date.now() + duration * 1000;
            localStorage.setItem(timerKey, endTime);
          } else {
            endTime = parseInt(localStorage.getItem(timerKey), 10);
          }
          timer.dataset.endtime = endTime;
        }
        timer.textContent = duration ? formatSeconds(Math.max(0, Math.floor(((endTime || 0) - Date.now()) / 1000))) : "--:--";

        li.appendChild(checkbox);
        li.appendChild(taskLine);
        li.appendChild(timer);
        list.appendChild(li);
      });

      _activeTimersInterval = setInterval(updateAllActiveTaskTimers, 1000);
      updateAllActiveTaskTimers(); // update immediately
    }

    // Format MM:SS
    function formatSeconds(seconds) {
      if (!seconds || seconds <= 0) return "00:00";
      let m = Math.floor(seconds / 60);
      let s = seconds % 60;
      return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
    }

    function updateAllActiveTaskTimers() {
      document.querySelectorAll(".task-timer").forEach(span => {
        const endTime = parseInt(span.dataset.endtime, 10);
        if (!endTime) {
          span.textContent = "--:--";
          return;
        }
        let diff = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
        span.textContent = formatSeconds(diff);
        if (diff <= 0) {
          span.textContent = "â°";
        }
      });
    }

    // ==================
    // Modal
    function openStartModal(title, id, durationMinutes) {
      const modal = document.getElementById("startTaskModal");
      modal.classList.add("show");
      modal.dataset.task = title;
      modal.dataset.taskid = id;
      if (durationMinutes) {
        document.getElementById("startMinutes").value = durationMinutes;
      }
    }

    async function startTimer() {
      const m = document.getElementById("startTaskModal");
      const mins = parseInt(document.getElementById("startMinutes").value, 10);
      const taskId = m.dataset.taskid;
      // Set status to ACTIVE and update durationMinutes if changed
      const task = allTasks.find(t => t.id == taskId);
      if (task) {
        let updatedTask = { ...task, status: "ACTIVE" };
        if (mins && mins !== task.durationMinutes) {
          updatedTask.durationMinutes = mins;
        }
        await fetch(`${API_BASE}/api/tasks/${taskId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", "X-User": user },
          body: JSON.stringify(updatedTask)
        });
        // Reset timer start for this task
        if (mins) {
          let endTime = Date.now() + mins * 60 * 1000;
          localStorage.setItem(`activeTask_${taskId}_endTime`, endTime);
        }
        m.classList.remove("show");
        loadTasks();
      }
    }

    async function updateTaskStatus(taskId, newStatus) {
      const task = allTasks.find(t => t.id === Number(taskId));
      if (!task) return;
      const updatedTask = { ...task, status: newStatus };
      await fetch(`${API_BASE}/api/tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", "X-User": user },
        body: JSON.stringify(updatedTask)
      });
      // If marked completed, clean up timer
      if (newStatus === "COMPLETED") {
        localStorage.removeItem(`activeTask_${taskId}_endTime`);
      }
    }

    async function addTask() {
      const title = document.getElementById('taskTitle').value.trim();
      const date = document.getElementById('taskDate').value;
      const durationMinutes = document.getElementById('taskDuration').value;
      if (!title) {
        alert("Enter a title, please! (or just a bunch of swear words if you're feeling spicy)");
        return;
      }
      await fetch(`${API_BASE}/api/tasks`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-User": user
        },
        body: JSON.stringify({
          title,
          taskDate: date,
          durationMinutes: durationMinutes ? parseInt(durationMinutes) : undefined
        })
      });
      document.getElementById('taskTitle').value = '';
      document.getElementById('taskDate').value = '';
      document.getElementById('taskDuration').value = '';
      await loadTasks();
    }

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("userDisplay").innerText = user;

      document.getElementById("logoutBtn").onclick = function() {
        localStorage.removeItem("currentUser");
        window.location.href = "index.html";
      };

      const headerCustomPicker = flatpickr("#headerCustomDateInput", {
        minDate: "today",
        dateFormat: "Y-m-d",
        disableMobile: true,
        allowInput: false,
        onChange: function(selectedDates, dateStr) {
          if(dateStr) {
            currentDateFilter = "custom";
            currentCustomDate = dateStr;
            updateHeader("custom", dateStr);
            hideDropdown();
            filterAndRenderTasks();
          }
        }
      });

      const dateDisplay = document.getElementById('dateDisplay');
      const dropdown = document.getElementById('dateDropdown');
      const customInput = document.getElementById('headerCustomDateInput');

      function showDropdown() {
        dropdown.classList.add('open');
        dateDisplay.classList.add('open');
      }
      function hideDropdown() {
        dropdown.classList.remove('open');
        dateDisplay.classList.remove('open');
        customInput.style.display = 'none';
      }

      dateDisplay.addEventListener('click', function(e) {
        e.stopPropagation();
        if(dropdown.classList.contains('open')) {
          hideDropdown();
        } else {
          showDropdown();
        }
      });

      Array.from(dropdown.querySelectorAll('.dropdown-item')).forEach(item => {
        item.addEventListener('click', function() {
          const value = item.getAttribute('data-value');
          if(value === "custom") {
            customInput.style.display = "inline-block";
            setTimeout(() => headerCustomPicker.open(), 50);
          } else {
            currentDateFilter = value;
            currentCustomDate = null;
            updateHeader(value);
            hideDropdown();
            filterAndRenderTasks();
          }
        });
      });

      document.addEventListener('click', function(e) {
        if(!dropdown.contains(e.target) && !dateDisplay.contains(e.target)) {
          hideDropdown();
        }
      });

      window.updateHeader = function(value, customDate) {
        let label = "Today";
        if(value === "tomorrow") label = "Tomorrow";
        if(value === "this_week") label = "This Week";
        if(value === "next_week") label = "Next Week";
        if(value === "custom" && customDate) {
          const dt = new Date(customDate);
          label = dt.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
        }
        dateDisplay.childNodes[0].textContent = label + " ";
      };

      loadTasks();
    });

    document.addEventListener("DOMContentLoaded", function() {
      flatpickr("#taskDate", {
        minDate: "today",
        dateFormat: "Y-m-d",
        disableMobile: true,
        allowInput: false,
        monthSelectorType: "dropdown",
        onReady: function(selectedDates, dateStr, instance) {
          const styleToday = () => {
            setTimeout(() => {
              const todayElem = instance.calendarContainer.querySelector(".flatpickr-day.today");
              if (todayElem) {
                todayElem.style.background = "transparent";
                todayElem.style.color = "#0ff";
                todayElem.style.border = "2px solid #ff00ff";
                todayElem.style.boxShadow = "0 0 12px #ff00ff, 0 0 24px #0ff";
                todayElem.style.borderRadius = "7px";
                todayElem.style.fontWeight = "bold";
              }
            }, 5);
          };
          styleToday();
          instance.calendarContainer.addEventListener("monthChange", styleToday);
        }
      });
    });

  </script>
</body>
</html>
